<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAA+vr/ABFmmQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAgICAgICAAAAAAAAAgICAgECAgICAgICAAAAAgICAgIBAgICAgICAgIAAAICAgICAQEBAgICAgICAAICAgICAgECAgECAgECAQICAgICAgIBAgICAQIBAQECAgICAgICAQICAQICAQIBAgICAgECAgEBAQICAgIBAgICAgIBAgICAgICAgICAgICAgICAQEBAgICAgICAgICAgICAgECAgECAgIBAgICAgICAgIBAgICAQIBAgECAgICAAICAQICAQICAQIBAgICAgECAgEBAQICAgIBAgICAgAAAAICAgICAgICAgICAgAAAAAAAAICAgICAgICAAAAAPAPAADAAwAAgAEAAIABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAACAAQAAwAMAAPAPAAA=" rel="icon" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <title>–í—ã–±–æ—Ä –¥–æ–º–∞</title>
  <style>
    /* –¶–≤–µ—Ç–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–º */
    :root {
      --bg: #f5f7fa;
      --card-bg: white;
      --text: #202124;
      --text-secondary: #333;
      --border: #e0e0e0;
      --shadow: rgba(0,0,0,0.05);
      --shadow-hover: rgba(0,0,0,0.1);
      --button-bg: #1a73e8;
      --button-hover: #0d5bb8;
      --results-bg: white;
      --results-border: #f0f0f0;
      --link: #0066cc;
    }

    .dark-mode {
      --bg: #121212;
      --card-bg: #1e1e1e;
      --text: #e0e0e0;
      --text-secondary: #ccc;
      --border: #333;
      --shadow: rgba(0,0,0,0.2);
      --shadow-hover: rgba(0,0,0,0.3);
      --button-bg: #5a96f7;
      --button-hover: #3a76d7;
      --results-bg: #1e1e1e;
      --results-border: #333;
      --link: #64b5f6;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      background: var(--bg);
      color: var(--text);
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      transition: background-color 0.3s, color 0.3s;
    }

    .house {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 8px;
      width: 290px;
      display: inline-block;
      vertical-align: top;
      background: var(--card-bg);
      box-shadow: 0 2px 6px var(--shadow);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .house:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px var(--shadow-hover);
    }

    .house img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }

    input[type="text"] {
      padding: 10px;
      width: 320px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      margin-bottom: 20px;
      background: var(--card-bg);
      color: var(--text);
    }

    button {
      padding: 12px 24px;
      font-size: 18px;
      background: var(--button-bg);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    button:hover {
      background: var(--button-hover);
    }

    #status {
      margin-top: 20px;
      font-weight: bold;
      min-height: 24px;
    }

    h2, h3 {
      color: var(--text);
      margin-bottom: 10px;
    }

    .results-box {
      background: var(--results-bg);
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 2px 6px var(--shadow);
    }

    .results-title {
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--text);
    }

    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--results-border);
      color: var(--text-secondary);
    }

    .result-count {
      font-weight: bold;
      color: var(--button-bg);
    }

    @media (max-width: 600px) {
      .result-row {
        flex-direction: column;
        gap: 4px;
      }
      .result-row span:last-child {
        text-align: right;
      }
    }

    #house-map {
      width: 100%;
      height: 300px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 6px var(--shadow);
    }

    /* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã */
    #theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      z-index: 1000;
    }
  </style>
</head>
<body>
  <!-- –ö–Ω–æ–ø–∫–∞ —Ç—ë–º–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ -->
  <button id="theme-toggle">üåì</button>

  <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–æ–º–∞ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</h2>
  <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)" />
  
  <h3>–ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–æ–º–∞</h3>
  <div id="house-map"></div>
  
  <div id="houses-container">
    <!-- –î–æ–º–∞ –ø–æ–¥–≥—Ä—É–∑—è—Ç—Å—è —Å—é–¥–∞ -->
  </div>

  <br><br>
  <button onclick="submitVote()">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>
  
  <h3>–¢–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
  <div id="results-container">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>
  </div>
  
  <div id="status"></div>

  <script>
    // üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π URL –∏–∑ Apps Script (–±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤!)
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwrMeJhIM7_Hq9viUzcu7KXAGdv1brBFlWfP7Wvmx2a6L71HvpXgmIk06zFruYZBpl-vg/exec";

    // ========== –¢–Å–ú–ù–´–ô –†–ï–ñ–ò–ú ==========
    function initThemeToggle() {
      const toggle = document.getElementById('theme-toggle');
      const body = document.body;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é —Ç–µ–º—É –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω—É—é
      const savedTheme = localStorage.getItem('theme');
      const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

      if (savedTheme === 'dark' || (!savedTheme && systemPrefersDark)) {
        body.classList.add('dark-mode');
        toggle.textContent = 'üåû'; // –°–æ–ª–Ω—Ü–µ ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—ã–π —Ä–µ–∂–∏–º
      } else {
        toggle.textContent = 'üåô'; // –õ—É–Ω–∞ ‚Äî –≤–∫–ª—é—á–∏—Ç—å —Ç—ë–º–Ω—ã–π —Ä–µ–∂–∏–º
      }

      toggle.addEventListener('click', () => {
        body.classList.toggle('dark-mode');
        const isDark = body.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        toggle.textContent = isDark ? 'üåû' : 'üåô';
      });
    }

    // ========== –ó–ê–ì–†–£–ó–ö–ê –î–û–ú–û–í –ò –ö–ê–†–¢–´ ==========
    async function loadHouses() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getHouses`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const houses = await res.json();
        
        const container = document.getElementById("houses-container");
        if (houses.length === 0) {
          container.innerHTML = "<p>–ù–µ—Ç –¥–æ–º–æ–≤ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.</p>";
          return;
        }

        container.innerHTML = houses.map(h => `
          <label class="house">
            <input type="checkbox" value="${h.id}">
            <img src="${h.—Ñ–æ—Ç–æ_url}" onerror="this.src='https://via.placeholder.com/300x150?text=–§–æ—Ç–æ+–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'">
            <div><strong>${h.–Ω–∞–∑–≤–∞–Ω–∏–µ}</strong></div>
            <div>üí∞ –°—É—Ç–∫–∏: ${h.—Ü–µ–Ω–∞_—Å—É—Ç–∫–∏ || '‚Äî'} ‚ÇΩ</div>
            <div>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 3 —Å–µ–º—å–∏ —Ç–æ–º—Å–∫–∏–µ: ${h.—Ü–µ–Ω–∞_—Ç–æ–º—Å–∫–∏–µ || '‚Äî'} ‚ÇΩ</div>
            <div>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 1 —Å–µ–º—å—è –∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∞—è: ${h.—Ü–µ–Ω–∞_–∫—Ä–∞—Å || '‚Äî'} ‚ÇΩ</div>
            <div>‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: ${h.–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ || ''}</div>
            <div>üó∫Ô∏è –î–æ –≥–æ—Ä—ã: ${h.—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ || '‚Äî'} –∫–º</div>
            ${h.–∞–≤–∏—Ç–æ_—Å—Å—ã–ª–∫–∞ ? `<div><a href="${h.–∞–≤–∏—Ç–æ_—Å—Å—ã–ª–∫–∞}" target="_blank" style="color: var(--link); text-decoration: underline;">üîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ê–≤–∏—Ç–æ</a></div>` : ''}
          </label>
        `).join('');

        // --- –ö–∞—Ä—Ç–∞ ---
        if (typeof L !== 'undefined') {
          const mapContainer = document.getElementById('house-map');
          if (mapContainer) {
            mapContainer.innerHTML = '';
            const map = L.map('house-map').setView([52.943187, 87.977159], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            houses.forEach(house => {
              if (house.—à–∏—Ä–æ—Ç–∞ && house.–¥–æ–ª–≥–æ—Ç–∞) {
                const lat = parseFloat(house.—à–∏—Ä–æ—Ç–∞);
                const lng = parseFloat(house.–¥–æ–ª–≥–æ—Ç–∞);
                if (!isNaN(lat) && !isNaN(lng)) {
                  const marker = L.marker([lat, lng]).addTo(map);
                  let popupContent = `<strong>${house.–Ω–∞–∑–≤–∞–Ω–∏–µ}</strong>`;
                  if (house.—Ñ–æ—Ç–æ_url) {
                    popupContent += `<br><img src="${house.—Ñ–æ—Ç–æ_url}" width="150" style="border-radius: 6px; margin-top: 6px;">`;
                  }
                  marker.bindPopup(popupContent);
                }
              }
            });
          }
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–º–æ–≤:", err);
        document.getElementById("houses-container").innerHTML = 
          `<p style="color:red">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    // ========== –û–¢–ü–†–ê–í–ö–ê –ì–û–õ–û–°–ê ==========
    async function submitVote() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è!");
        return;
      }
      const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(el => el.value);

      if (checked.length === 0) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–º!");
        return;
      }

      const housesParam = encodeURIComponent(checked.join(","));
      const url = `${WEB_APP_URL}?action=vote&name=${encodeURIComponent(name)}&houses=${housesParam}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        if (result.status === "ok") {
          document.getElementById("status").innerText = "‚úÖ –ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç! –°–ø–∞—Å–∏–±–æ!";
          loadResults();
          document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
        } else {
          throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É");
        }
      } catch (err) {
        document.getElementById("status").innerText = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
        console.error(err);
      }
    }

    // ========== –ó–ê–ì–†–£–ó–ö–ê –ò–¢–û–ì–û–í ==========
    async function loadResults() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getResults`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const results = await res.json();

        const container = document.getElementById("results-container");
        if (results.length === 0) {
          container.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤.</p>";
          return;
        }

        results.sort((a, b) => b.–≥–æ–ª–æ—Å–æ–≤ - a.–≥–æ–ª–æ—Å–æ–≤);

        container.innerHTML = `
          <div class="results-box">
            <div class="results-title">–†–µ–π—Ç–∏–Ω–≥ –¥–æ–º–æ–≤</div>
            ${results.map(r => `
              <div class="result-row">
                <span>${r.–Ω–∞–∑–≤–∞–Ω–∏–µ}</span>
                <span class="result-count">${r.–≥–æ–ª–æ—Å–æ–≤} ${r.–≥–æ–ª–æ—Å–æ–≤ === 1 ? '–≥–æ–ª–æ—Å' : r.–≥–æ–ª–æ—Å–æ–≤ < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤'}</span>
              </div>
            `).join('')}
          </div>
        `;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Ç–æ–≥–æ–≤:", err);
        document.getElementById("results-container").innerHTML = 
          `<p style="color:red">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Ç–æ–≥–∏</p>`;
      }
    }

    // ========== –ó–ê–ü–£–°–ö ==========
    initThemeToggle();
    loadHouses();
    loadResults();
  </script>
</body>
</html>
