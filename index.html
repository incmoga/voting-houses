<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="data:image/x-icon;base64,AAABAAEAEBAAAAAAAABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAAAAAAA+vr/ABFmmQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAICAgICAgICAAAAAAAAAgICAgECAgICAgICAAAAAgICAgIBAgICAgICAgIAAAICAgICAQEBAgICAgICAAICAgICAgECAgECAgECAQICAgICAgIBAgICAQIBAQECAgICAgICAQICAQICAQIBAgICAgECAgEBAQICAgIBAgICAgIBAgICAgICAgICAgICAgICAgICAQEBAgICAgICAgICAgICAgECAgECAgIBAgICAgICAgIBAgICAQIBAgECAgICAAICAQICAQICAQIBAgICAgECAgEBAQICAgIBAgICAgAAAAICAgICAgICAgICAgAAAAAAAAICAgICAgICAAAAAPAPAADAAwAAgAEAAIABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIABAACAAQAAwAMAAPAPAAA=" rel="icon" type="image/x-icon">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º CSS –¥–ª—è LinearMeasurement -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/zakhar7/Leaflet-LinearMeasurement@master/dist/leaflet.linear.css" />
  
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º JS –¥–ª—è LinearMeasurement -->
  <script src="https://cdn.jsdelivr.net/gh/zakhar7/Leaflet-LinearMeasurement@master/dist/leaflet.linear.js"></script>
  
  <title>–í—ã–±–æ—Ä –¥–æ–º–∞</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 20px;
      background: #f5f7fa;
      max-width: 1200px;
      margin: 0 auto;
    }
    .house {
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      padding: 16px;
      margin: 16px 8px;
      width: 290px;
      display: inline-block;
      vertical-align: top;
      background: white;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    .house:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .house img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    input[type="text"] {
      padding: 10px;
      width: 320px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    button {
      padding: 12px 24px;
      font-size: 18px;
      background: #1a73e8;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background: #0d5bb8;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
      min-height: 24px;
    }
    h2, h3 {
      color: #202124;
      margin: 20px 0 10px;
    }

    .results-box {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .results-title {
      font-weight: bold;
      margin-bottom: 12px;
      color: #202124;
    }
    .result-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
      color: #333;
    }
    .result-count {
      font-weight: bold;
      color: #1a73e8;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ª–∏–Ω–µ–π–∫–∏ */
    .leaflet-draw-toolbar {
      margin-top: 12px;
    }
    
    .leaflet-draw-toolbar a {
      background-color: #fff;
      border-radius: 4px;
    }
    
    .leaflet-draw-toolbar a:hover {
      background-color: #f4f4f4;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ª–∏–Ω–µ–π–∫–∏ */
    .leaflet-linear-measure {
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.4);
    }
    
    @media (max-width: 600px) {
      .result-row {
        flex-direction: column;
        gap: 4px;
      }
      .result-row span:last-child {
        text-align: right;
      }
    }
    #house-map {
      width: 100%;
      height: 350px;
      border-radius: 12px;
      margin: 20px 0;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
  </style>
</head>
<body>
  <h2>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –¥–æ–º–∞ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</h2>
  <input type="text" id="name" placeholder="–í–∞—à–µ –∏–º—è (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!)" />

  <h3>–ì–¥–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –¥–æ–º–∞</h3>
  <div id="house-map"></div>

  <div id="houses-container">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–º–æ–≤...</p>
  </div>

  <br><br>
  <button onclick="submitVote()">–ü—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å</button>

  <h3>–¢–µ–∫—É—â–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>
  <div id="results-container">
    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤...</p>
  </div>

  <div id="status"></div>

  <script>
    // üî¥ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL –ò–ó APPS SCRIPT (–ë–ï–ó –ü–†–û–ë–ï–õ–û–í!)
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwrMeJhIM7_Hq9viUzcu7KXAGdv1brBFlWfP7Wvmx2a6L71HvpXgmIk06zFruYZBpl-vg/exec";

    // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    let map;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–º–æ–≤ –∏ –∫–∞—Ä—Ç—ã
    async function loadHouses() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getHouses`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const houses = await res.json();
        
        const container = document.getElementById("houses-container");
        if (houses.length === 0) {
          container.innerHTML = "<p>–ù–µ—Ç –¥–æ–º–æ–≤ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è.</p>";
          return;
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫
        container.innerHTML = houses.map(h => {
          const color = h.—Ü–≤–µ—Ç_–º–∞—Ä–∫–µ—Ä–∞ || '#888888';
          return `
            <label class="house">
              <input type="checkbox" value="${h.id}">
              <img src="${h.—Ñ–æ—Ç–æ_url}" onerror="this.src='https://via.placeholder.com/300x150?text=–§–æ—Ç–æ+–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'">
              <div style="display: flex; align-items: center; gap: 6px; margin: 6px 0;">
                <span style="
                  display: inline-block;
                  width: 12px;
                  height: 12px;
                  border-radius: 50%;
                  background-color: ${color};
                  border: 1px solid rgba(0,0,0,0.2);
                "></span>
                <strong>${h.–Ω–∞–∑–≤–∞–Ω–∏–µ}</strong>
              </div>
              <div>üí∞ –°—É—Ç–∫–∏: ${h.—Ü–µ–Ω–∞_—Å—É—Ç–∫–∏ || '‚Äî'} ‚ÇΩ</div>
              <div>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 3 —Å–µ–º—å–∏ —Ç–æ–º—Å–∫–∏–µ: ${h.—Ü–µ–Ω–∞_—Ç–æ–º—Å–∫–∏–µ || '‚Äî'} ‚ÇΩ</div>
              <div>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ 1 —Å–µ–º—å—è –∫—Ä–∞—Å–Ω–æ—è—Ä—Å–∫–∏–µ: ${h.—Ü–µ–Ω–∞_–∫—Ä–∞—Å || '‚Äî'} ‚ÇΩ</div>
              <div>‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: ${h.–æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ || ''}</div>
              <div>üó∫Ô∏è –î–æ –≥–æ—Ä—ã: ${h.—Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ || '‚Äî'} –∫–º</div>
              ${h.–∞–≤–∏—Ç–æ_—Å—Å—ã–ª–∫–∞ ? `<div><a href="${h.–∞–≤–∏—Ç–æ_—Å—Å—ã–ª–∫–∞}" target="_blank" style="color: #0066cc; text-decoration: underline;">üîó –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ –ê–≤–∏—Ç–æ</a></div>` : ''}
            </label>
          `;
        }).join('');

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
        renderHouseMap(houses);

      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–º–æ–≤:", err);
        document.getElementById("houses-container").innerHTML = 
          `<p style="color:red">‚ùå –û—à–∏–±–∫–∞: ${err.message}</p>`;
      }
    }

    // –ö–∞—Ä—Ç–∞ —Å –º–∞—Ä–∫–µ—Ä–∞–º–∏ –∏ –ª–∏–Ω–µ–π–∫–æ–π
    function renderHouseMap(houses) {
      const mapContainer = document.getElementById('house-map');
      if (!mapContainer) return;
      mapContainer.innerHTML = '';

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
      map = L.map('house-map').setView([52.943187, 87.977159], 12);

      // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–π –∫–∞—Ä—Ç—ã
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é –∏–∑ GitHub
      map.addControl(new L.Control.LinearMeasurement({
        position: 'topright',
        unitSystem: 'metric', // –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ç—Ä–∏—á–µ—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É –≤–º–µ—Å—Ç–æ imperial
        color: '#1a73e8', // —Å–∏–Ω–∏–π —Ü–≤–µ—Ç –≤–º–µ—Å—Ç–æ —Ä–æ–∑–æ–≤–æ–≥–æ
        type: 'line',
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –æ–ø–∏—Å–∞–Ω–∏—è
        fillColor: '#fff',
        features: ['line', 'ruler', 'trash'], // –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        pallette: ['#1a73e8', '#FF0080', 'red', 'blue', 'green', 'orange', 'black'],
        dashArray: '5, 5',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.5,
        radius: 4
      }));

      // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –¥–æ–º–æ–≤
      houses.forEach(house => {
        if (house.—à–∏—Ä–æ—Ç–∞ && house.–¥–æ–ª–≥–æ—Ç–∞) {
          const lat = parseFloat(house.—à–∏—Ä–æ—Ç–∞);
          const lng = parseFloat(house.–¥–æ–ª–≥–æ—Ç–∞);
          if (!isNaN(lat) && !isNaN(lng)) {
            const color = house.—Ü–≤–µ—Ç_–º–∞—Ä–∫–µ—Ä–∞ || '#888888';
            const marker = L.marker([lat, lng], {
              icon: L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                  background: ${color};
                  width: 30px;
                  height: 40px;
                  position: relative;
                  clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
                  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                ">
                  <div style="
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                  ">‚óè</div>
                </div>`,
                iconSize: [30, 40],
                iconAnchor: [15, 40]
              })
            }).addTo(map);

            let popupContent = `<strong>${house.–Ω–∞–∑–≤–∞–Ω–∏–µ}</strong>`;
            if (house.—Ñ–æ—Ç–æ_url) {
              popupContent += `<br><img src="${house.—Ñ–æ—Ç–æ_url}" width="150" style="border-radius: 6px; margin-top: 6px;">`;
            }
            marker.bindPopup(popupContent);
          }
        }
      });
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–∞
    async function submitVote() {
      const name = document.getElementById("name").value.trim();
      if (!name) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–º—è!");
        return;
      }
      const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
        .map(el => el.value);

      if (checked.length === 0) {
        alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ–º!");
        return;
      }

      const housesParam = encodeURIComponent(checked.join(","));
      const url = `${WEB_APP_URL}?action=vote&name=${encodeURIComponent(name)}&houses=${housesParam}`;

      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const result = await res.json();
        if (result.status === "ok") {
          document.getElementById("status").innerText = "‚úÖ –ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç! –°–ø–∞—Å–∏–±–æ!";
          loadResults();
          document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
        } else {
          throw new Error("–°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É");
        }
      } catch (err) {
        document.getElementById("status").innerText = `‚ùå –û—à–∏–±–∫–∞: ${err.message}`;
        console.error(err);
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Ç–æ–≥–æ–≤
    async function loadResults() {
      try {
        const res = await fetch(`${WEB_APP_URL}?action=getResults`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const results = await res.json();

        const container = document.getElementById("results-container");
        if (results.length === 0) {
          container.innerHTML = "<p>–ü–æ–∫–∞ –Ω–µ—Ç –≥–æ–ª–æ—Å–æ–≤.</p>";
          return;
        }

        results.sort((a, b) => b.–≥–æ–ª–æ—Å–æ–≤ - a.–≥–æ–ª–æ—Å–æ–≤);

        container.innerHTML = `
          <div class="results-box">
            <div class="results-title">–†–µ–π—Ç–∏–Ω–≥ –¥–æ–º–æ–≤</div>
            ${results.map(r => `
              <div class="result-row">
                <span>${r.–Ω–∞–∑–≤–∞–Ω–∏–µ}</span>
                <span class="result-count">${r.–≥–æ–ª–æ—Å–æ–≤} ${r.–≥–æ–ª–æ—Å–æ–≤ === 1 ? '–≥–æ–ª–æ—Å' : r.–≥–æ–ª–æ—Å–æ–≤ < 5 ? '–≥–æ–ª–æ—Å–∞' : '–≥–æ–ª–æ—Å–æ–≤'}</span>
              </div>
            `).join('')}
          </div>
        `;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Ç–æ–≥–æ–≤:", err);
        document.getElementById("results-container").innerHTML = 
          `<p style="color:red">‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Ç–æ–≥–∏</p>`;
      }
    }

    // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    loadHouses();
    loadResults();
  </script>
</body>
</html>
